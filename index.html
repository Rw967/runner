<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ULTRA RUNNER - Global Ranking & Owner Edition V5</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <style>
        /* =========================================
           BASE STYLES & VARIABLES
           ========================================= */
        :root {
            --primary-blue: #3b82f6;
            --accent-pink: #ec4899;
            --gold-winner: #fbbf24;
            --bg-deep: #020617;
            --danger-red: #ef4444;
            --success-green: #22c55e;
            --panel-glass: rgba(15, 23, 42, 0.96);
            --border-light: rgba(255, 255, 255, 0.1);
            --text-main: #f8fafc;
            --text-dim: #94a3b8;
        }

        * {
            box-sizing: border-box;
            outline: none;
        }

        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: var(--bg-deep);
            font-family: 'Inter', 'Segoe UI', Roboto, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            color: var(--text-main);
            user-select: none;
        }

        /* =========================================
           BACKGROUND ANIMATION
           ========================================= */
        #bg-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        /* =========================================
           MAIN GAME CONTAINER
           ========================================= */
        #game-container {
            position: relative;
            width: 1050px;
            height: 650px;
            border-radius: 35px;
            overflow: hidden;
            box-shadow: 0 0 100px rgba(59, 130, 246, 0.4);
            background-color: #0f172a;
            border: 4px solid rgba(255, 255, 255, 0.08);
        }

        /* =========================================
           UI SCREENS (OVERLAYS)
           ========================================= */
        .ui-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(7, 10, 20, 0.98);
            backdrop-filter: blur(25px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .panel {
            background: rgba(255, 255, 255, 0.03);
            padding: 45px;
            border-radius: 30px;
            border: 1px solid var(--border-light);
            text-align: center;
            width: 550px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
        }

        /* =========================================
           TYPOGRAPHY
           ========================================= */
        h1 {
            font-size: 55px;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #3b82f6 0%, #ec4899 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-transform: uppercase;
            font-weight: 900;
            letter-spacing: -1px;
        }

        h2 {
            font-size: 14px;
            color: var(--primary-blue);
            text-transform: uppercase;
            letter-spacing: 4px;
            margin-bottom: 10px;
        }

        h3 {
            font-size: 20px;
            color: var(--gold-winner);
            text-transform: uppercase;
            margin-bottom: 20px;
        }

        /* =========================================
           BUTTONS & INPUTS
           ========================================= */
        .menu-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid var(--primary-blue);
            color: white;
            padding: 18px 25px;
            border-radius: 15px;
            cursor: pointer;
            width: 100%;
            margin: 12px 0;
            font-weight: 800;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

            .menu-btn:hover {
                background: var(--primary-blue);
                transform: translateY(-3px) scale(1.02);
                box-shadow: 0 10px 30px rgba(59, 130, 246, 0.5);
            }

        .danger-btn {
            border-color: var(--danger-red);
            color: var(--danger-red);
        }

            .danger-btn:hover {
                background: var(--danger-red);
                color: white;
                box-shadow: 0 10px 30px rgba(239, 68, 68, 0.4);
            }

        input[type="text"],
        input[type="number"],
        select {
            width: 95%;
            padding: 18px;
            margin: 15px 0;
            border-radius: 12px;
            border: 2px solid var(--border-light);
            background: rgba(0, 0, 0, 0.5);
            color: white;
            text-align: center;
            font-size: 18px;
            transition: 0.3s;
        }

        input:focus {
            border-color: var(--accent-pink);
            background: rgba(0, 0, 0, 0.8);
        }

        /* =========================================
           LEADERBOARD TABS (Rocket League Style)
           ========================================= */
        .tabs-header {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            background: rgba(0, 0, 0, 0.4);
            padding: 10px;
            border-radius: 20px;
            width: 85%;
            justify-content: center;
        }

        .tab-trigger {
            background: transparent;
            border: none;
            color: var(--text-dim);
            padding: 15px 35px;
            font-weight: 900;
            cursor: pointer;
            text-transform: uppercase;
            font-size: 14px;
            letter-spacing: 2px;
            transition: 0.4s;
            border-radius: 12px;
        }

            .tab-trigger.active {
                color: white;
                background: var(--primary-blue);
                box-shadow: 0 5px 20px rgba(59, 130, 246, 0.4);
            }

        .ranking-container {
            width: 90%;
            height: 420px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .rank-item {
            display: grid;
            grid-template-columns: 60px 1fr 120px;
            padding: 20px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 15px;
            align-items: center;
            border: 1px solid transparent;
            transition: 0.2s;
        }

            .rank-item:hover {
                background: rgba(255, 255, 255, 0.07);
                border-color: var(--border-light);
            }

        .rank-number {
            font-weight: 900;
            font-size: 20px;
            color: var(--gold-winner);
        }

        .rank-name {
            font-size: 20px;
            font-weight: 600;
            text-align: left;
            padding-left: 20px;
        }

        .rank-score {
            text-align: right;
            font-weight: 900;
            font-size: 22px;
            color: var(--success-green);
        }

        .me-highlight {
            border: 2px solid var(--success-green);
            background: rgba(34, 197, 94, 0.1);
        }

        /* =========================================
           HUD & OVERLAYS
           ========================================= */
        #hud-display {
            position: absolute;
            top: 35px;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 70px;
            pointer-events: none;
            z-index: 50;
        }

        .hud-stat {
            font-size: 30px;
            font-weight: 900;
            text-shadow: 3px 3px 10px rgba(0,0,0,0.8);
        }

        #home-nav-btn {
            position: absolute;
            top: 30px;
            left: 30px;
            width: 60px;
            height: 60px;
            background: rgba(255,255,255,0.05);
            border: 2px solid var(--primary-blue);
            border-radius: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            z-index: 200;
            transition: 0.3s;
        }

            #home-nav-btn:hover {
                background: var(--primary-blue);
                transform: rotate(-10deg) scale(1.1);
            }

        #countdown-text {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 280px;
            font-weight: 900;
            color: var(--gold-winner);
            z-index: 1000;
            pointer-events: none;
            text-shadow: 0 0 80px rgba(0,0,0,0.9);
        }

        /* =========================================
           MISC
           ========================================= */
        .hidden {
            display: none !important;
        }

        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-blue);
            border-radius: 10px;
            border: 2px solid #0f172a;
        }
    </style>
</head>
<body>

    <canvas id="bg-canvas"></canvas>

    <div id="game-container">

        <div id="countdown-text" class="hidden"></div>

        <div id="home-nav-btn" class="hidden" onclick="returnToMenu()">üè†</div>

        <div id="hud-display" class="hidden">
            <div class="hud-stat" style="color: white;">SCORE: <span id="val-score">0</span></div>
            <div class="hud-stat" style="color: var(--gold-winner);">BEST: <span id="val-best">0</span></div>
            <div id="hud-timer" class="hud-stat hidden" style="color: var(--accent-pink);">TIME: <span id="val-time">60</span>s</div>
        </div>

        <canvas id="gameCanvas"></canvas>

        <div id="screen-login" class="ui-screen">
            <div class="panel">
                <h2>System-Initialisierung</h2>
                <h1>LOGIN</h1>
                <input type="text" id="userInput" placeholder="Dein Pilot-Name..." maxlength="12">
                <p id="loginError" style="color: var(--danger-red); font-size: 14px; height: 20px; margin: 10px 0;"></p>
                <button class="menu-btn" onclick="processLogin()">LOGIN BEST√ÑTIGEN</button>
            </div>
        </div>

        <div id="screen-main-menu" class="ui-screen hidden">
            <h2>Kommandozentrale</h2>
            <h1>ULTRA RUNNER</h1>
            <div class="panel" style="background:transparent; border:none; width: 650px;">
                <button class="menu-btn" onclick="showScreen('screen-solo-modes')">SOLO MISSION STARTEN</button>
                <button class="menu-btn" onclick="showScreen('screen-multi-lobby')" style="border-color: var(--accent-pink);">MULTIPLAYER ARENA</button>
                <button class="menu-btn" onclick="openGlobalRankings()" style="border-color: var(--gold-winner); color: var(--gold-winner);">LEADERBOARDS (GLOBAL)</button>

                <div style="margin-top: 50px; border-top: 1px solid var(--border-light); padding-top: 30px; display: flex; gap: 15px;">
                    <button class="menu-btn" onclick="showScreen('screen-settings')" style="font-size: 11px; opacity: 0.8;">OPTIONEN</button>
                    <button class="menu-btn danger-btn" onclick="showScreen('screen-confirm-reset')" style="font-size: 11px;">ACCOUNT L√ñSCHEN</button>
                </div>
            </div>
        </div>

        <div id="screen-leaderboards" class="ui-screen hidden">
            <h2>Halle des Ruhms</h2>
            <h1>RANKINGS</h1>

            <div class="tabs-header">
                <button class="tab-trigger active" id="tab-btn-global" onclick="setRankingTab('global')">WELTWEIT</button>
                <button class="tab-trigger" id="tab-btn-friends" onclick="setRankingTab('friends')">LOBBY (ONLINE)</button>
                <button class="tab-trigger" id="tab-btn-personal" onclick="setRankingTab('personal')">MEINE STATS</button>
            </div>

            <div class="panel" style="width: 85%; height: 480px; padding: 20px;">
                <div id="ranking-list-content" class="ranking-container">
                </div>
            </div>

            <button class="menu-btn" onclick="showScreen('screen-main-menu')" style="width: 250px; margin-top: 25px;">ZUR√úCK ZUR BASIS</button>
        </div>

        <div id="screen-solo-modes" class="ui-screen hidden">
            <h2>W√§hle deine Gefahr</h2>
            <h1>SOLO MODI</h1>
            <div class="panel">
                <button class="menu-btn" onclick="startGameSession('normal')">NORMALER LAUF</button>
                <button class="menu-btn" onclick="startGameSession('hardcore')">HARDCORE (PRO)</button>
                <button class="menu-btn" onclick="startGameSession('moon')">MOON (LOW GRAVITY)</button>
                <button class="menu-btn" onclick="startGameSession('speedrun')">SPEEDRUN (60 SEKUNDEN)</button>
                <button class="menu-btn" onclick="showScreen('screen-main-menu')" style="border:none; color: var(--text-dim);">ZUR√úCK</button>
            </div>
        </div>

        <div id="screen-multi-lobby" class="ui-screen hidden">
            <h2>Globaler Wettkampf</h2>
            <h1>MULTI LOBBY</h1>
            <div class="panel">
                <button class="menu-btn" onclick="createNewMultiRoom()">EIGENE LOBBY HOSTEN</button>

                <div style="margin: 30px 0; background: rgba(0,0,0,0.3); padding: 25px; border-radius: 20px;">
                    <p style="font-size: 12px; margin-bottom: 10px; letter-spacing: 2px;">BEITRITTS-CODE EINGEBEN</p>
                    <input type="text" id="joinRoomCode" placeholder="Z.B. X8J2" style="width: 70%;">
                    <button class="menu-btn" onclick="joinExistingRoom()">JETZT BEITRETEN</button>
                </div>

                <button class="menu-btn" onclick="showScreen('screen-main-menu')" style="border:none; color: var(--text-dim);">HAUPTMEN√ú</button>
            </div>
        </div>

        <div id="screen-room-view" class="ui-screen hidden">
            <h2>Lobby Aktiv</h2>
            <h1>CODE: <span id="code-display" style="color:var(--gold-winner)">----</span></h1>

            <div style="display: flex; gap: 35px; width: 94%; margin-top: 30px; align-items: flex-start;">

                <div class="panel" style="flex: 1; padding: 30px;">
                    <h3>PILOTEN BEREIT</h3>
                    <div id="lobby-member-list" style="text-align: left; min-height: 220px; background: rgba(0,0,0,0.4); border-radius: 15px; padding: 20px;"></div>
                    <button class="menu-btn danger-btn" onclick="leaveCurrentRoom()" style="margin-top: 20px;">LOBBY VERLASSEN</button>
                </div>

                <div class="panel" id="host-controls" style="flex: 1; padding: 30px;">
                    <h3>KONFIGURATION (HOST)</h3>

                    <div style="text-align:left; margin-bottom: 15px;">
                        <label style="font-size: 11px; color: var(--text-dim);">MODUS</label>
                        <select id="sel-mode">
                            <option value="normal">NORMAL</option>
                            <option value="hardcore">HARDCORE</option>
                            <option value="moon">MOONWALK</option>
                        </select>
                    </div>

                    <div style="text-align:left; margin-bottom: 15px;">
                        <label style="font-size: 11px; color: var(--text-dim);">MUSIK-TRACK</label>
                        <select id="sel-music">
                            <option value="1">TRACK 01: NEON DRIVE</option>
                            <option value="2">TRACK 02: CYBER CHASE</option>
                            <option value="3">TRACK 03: VAPOR RUN</option>
                        </select>
                    </div>

                    <div style="text-align:left; margin-bottom: 25px;">
                        <label style="font-size: 11px; color: var(--text-dim);">TIMER (SEK.)</label>
                        <input type="number" id="inp-time" value="60" min="10" max="999">
                    </div>

                    <button class="menu-btn" onclick="broadcastStartSignal()" style="background: var(--accent-pink); border:none; height: 65px; font-size: 20px;">START SEQUENZ EINLEITEN</button>
                </div>

            </div>
        </div>

        <div id="screen-game-over" class="ui-screen hidden">
            <div class="panel">
                <h2 style="color: var(--danger-red);">Mission gescheitert</h2>
                <h1 style="font-size: 75px; color: var(--accent-pink);">CRASH!</h1>

                <div style="margin: 40px 0; background: rgba(0,0,0,0.3); padding: 30px; border-radius: 20px;">
                    <p style="font-size: 35px; margin: 0;">SCORE: <span id="final-score" style="font-weight: 900;">0</span></p>
                    <p style="font-size: 20px; color: var(--gold-winner); margin-top: 10px;">DEIN REKORD: <span id="final-best">0</span></p>
                </div>

                <button class="menu-btn" onclick="retryLastGame()" style="height: 70px; font-size: 20px;">NOCHMAL VERSUCHEN</button>
                <button class="menu-btn" onclick="returnToMenu()">ZUR√úCK ZUM HAUPTMEN√ú</button>
            </div>
        </div>

        <div id="screen-confirm-reset" class="ui-screen hidden" style="background: rgba(127, 29, 29, 0.98);">
            <div class="panel" style="border-color: white;">
                <h1 style="color: white;">ACCOUNT L√ñSCHEN?</h1>
                <p style="margin: 30px 0; font-size: 18px; line-height: 1.6;">Achtung! Wenn du fortf√§hrst, werden dein Name und alle deine Highscores unwiderruflich aus dem System gel√∂scht. M√∂chtest du das wirklich?</p>

                <button class="menu-btn" onclick="performAccountDelete()" style="background: white; color: var(--danger-red); border: none;">JA, ALLES L√ñSCHEN</button>
                <button class="menu-btn" onclick="showScreen('screen-main-menu')" style="border-color: white;">NEIN, ABBRECHEN</button>
            </div>
        </div>

    </div>

    <script>
        /* =========================================
        CORE SYSTEM SETUP
        ========================================= */
        const socket = io("https://runner-1-gp5g.onrender.com");
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const bgCanvas = document.getElementById('bg-canvas');
        const bctx = bgCanvas.getContext('2d');

        canvas.width = 1050;
        canvas.height = 650;

        const sfxJump = new Audio('https://www.soundjay.com/buttons/sounds/button-27.mp3');
        const sfxHit = new Audio('https://www.soundjay.com/buttons/sounds/button-10.mp3');
        let bgMusic = new Audio();
        bgMusic.loop = true;
        bgMusic.volume = 0.25;

        /* =========================================
        GLOBAL VARIABLES
        ========================================= */
        let activeUser = localStorage.getItem('ultraRunner_name') || "";
        let highscoreVal = parseInt(localStorage.getItem('ultraRunner_highscore')) || 0;

        let gameState = 'menu';
        let currentRoomID = null;
        let isLobbyHost = false;

        let gameScore = 0;
        let worldSpeed = 8.5;
        let activeObstacles = [];
        let timerSeconds = 60;
        let isJumpPressed = false;
        let jumpCharge = 0;

        let otherPlayers = {};
        let globalRankData = [];
        let currentRankTab = 'global';

        const runner = {
        x: 160,
        y: 450,
        w: 52,
        h: 52,
        dy: 0,
        gravity: 0.92,
        onGround: false
        };

        /* =========================================
        UI NAVIGATION FUNCTIONS
        ========================================= */
        function showScreen(screenId) {
        const allScreens = document.querySelectorAll('.ui-screen');
        allScreens.forEach(s => s.classList.add('hidden'));

        if (screenId !== 'none') {
        const target = document.getElementById(screenId);
        if (target) target.classList.remove('hidden');
        }
        }

        function processLogin() {
        const inputField = document.getElementById('userInput');
        const name = inputField.value.trim();

        if (name.length < 2) {
        document.getElementById('loginError').innerText = "Dein Name muss mindestens 2 Zeichen lang sein.";
        return;
        }

        activeUser = name;
        localStorage.setItem('ultraRunner_name', name);
        showScreen('screen-main-menu');
        }

        function performAccountDelete() {
        localStorage.clear();
        window.location.reload();
        }

        /* =========================================
        LEADERBOARD SYSTEM (Rocket League Inspired)
        ========================================= */
        function openGlobalRankings() {
        showScreen('screen-leaderboards');
        setRankingTab('global');
        }

        function setRankingTab(tabType) {
        currentRankTab = tabType;

        // Buttons stylen
        document.querySelectorAll('.tab-trigger').forEach(b => b.classList.remove('active'));
        document.getElementById('tab-btn-' + tabType).classList.add('active');

        buildRankingList();
        }

        function buildRankingList() {
        const listArea = document.getElementById('ranking-list-content');
        listArea.innerHTML = "";

        let displayData = [];

        if (currentRankTab === 'global') {
        // Kopie der Serverdaten sortieren
        displayData = [...globalRankData].sort((a, b) => b.s - a.s).slice(0, 50);
        }
        else if (currentRankTab === 'friends') {
        // Zeigt Spieler in der aktuellen Lobby oder Online-Nutzer
        for (let id in otherPlayers) {
        displayData.push({ n: otherPlayers[id].name, s: "IM MATCH" });
        }
        if (displayData.length === 0) {
        listArea.innerHTML = "<div style='text-align:center; padding-top:100px; opacity:0.4;'>KEINE SPIELER ONLINE</div>";
        return;
        }
        }
        else if (currentRankTab === 'personal') {
        displayData = [{ n: activeUser, s: highscoreVal }];
        }

        // HTML Generierung
        displayData.forEach((item, index) => {
        const row = document.createElement('div');
        row.className = `rank-item ${item.n === activeUser ? 'me-highlight' : ''}`;

        row.innerHTML = `
        <div class="rank-number">#${index + 1}</div>
        <div class="rank-name">${item.n}</div>
        <div class="rank-score">${item.s}</div>
        `;
        listArea.appendChild(row);
        });
        }

        /* =========================================
        MULTIPLAYER LOBBY LOGIC
        ========================================= */
        function createNewMultiRoom() {
        const code = Math.random().toString(36).substring(2, 6).toUpperCase();
        currentRoomID = code;
        isLobbyHost = true;

        socket.emit('joinRoom', { room: code, name: activeUser });

        document.getElementById('code-display').innerText = code;
        document.getElementById('host-controls').classList.remove('hidden');
        showScreen('screen-room-view');
        }

        function joinExistingRoom() {
        const codeInput = document.getElementById('joinRoomCode');
        const code = codeInput.value.trim().toUpperCase();

        if (code.length !== 4) return;

        currentRoomID = code;
        isLobbyHost = false;

        socket.emit('joinRoom', { room: code, name: activeUser });

        document.getElementById('code-display').innerText = code;
        document.getElementById('host-controls').classList.add('hidden');
        showScreen('screen-room-view');
        }

        function leaveCurrentRoom() {
        if (currentRoomID) {
        socket.emit('leaveRoom', currentRoomID);
        }
        currentRoomID = null;
        isLobbyHost = false;
        showScreen('screen-multi-lobby');
        }

        /* FIX: Solo-Start & Globaler Start-Countdown */
        function broadcastStartSignal() {
        const startSettings = {
        mode: document.getElementById('sel-mode').value,
        music: document.getElementById('sel-music').value,
        time: document.getElementById('inp-time').value
        };

        // Sendet an den Server, dass der Raum starten soll
        socket.emit('triggerLobbyStart', {
        room: currentRoomID,
        config: startSettings
        });
        }

        socket.on('lobbyCountdownStarted', (config) => {
        let count = 5;
        const overlay = document.getElementById('countdown-text');

        showScreen('none');
        overlay.classList.remove('hidden');
        overlay.innerText = count;

        const timer = setInterval(() => {
        count--;
        if (count > 0) {
        overlay.innerText = count;
        } else {
        clearInterval(timer);
        overlay.classList.add('hidden');
        startGameSession(config.mode, config);
        }
        }, 1000);
        });

        function returnToMenu() {
        bgMusic.pause();
        if (currentRoomID) {
        showScreen('screen-room-view');
        } else {
        showScreen('screen-main-menu');
        }
        gameState = 'menu';
        document.getElementById('hud-display').classList.add('hidden');
        document.getElementById('home-nav-btn').classList.add('hidden');
        }

        /* =========================================
        GAME ENGINE & PHYSICS
        ========================================= */
        function startGameSession(modeType, config = null) {
        gameState = 'playing';
        gameScore = 0;
        timerSeconds = config ? parseInt(config.time) : (modeType === 'speedrun' ? 60 : 999);
        worldSpeed = (modeType === 'hardcore' ? 12.5 : 9.0);
        activeObstacles = [];

        runner.y = 450;
        runner.dy = 0;
        runner.gravity = (modeType === 'moon' ? 0.38 : 0.92);

        // Musik-Management
        if (config && config.music) {
        bgMusic.src = `https://www.soundhelix.com/examples/mp3/SoundHelix-Song-${config.music}.mp3`;
        bgMusic.play().catch(err => console.log("Audio Error"));
        }

        // UI Elements einblenden
        showScreen('none');
        document.getElementById('hud-display').classList.remove('hidden');
        document.getElementById('home-nav-btn').classList.remove('hidden');

        if (modeType === 'speedrun' || config) {
        document.getElementById('hud-timer').classList.remove('hidden');
        } else {
        document.getElementById('hud-timer').classList.add('hidden');
        }

        document.getElementById('val-score').innerText = "0";
        document.getElementById('val-best').innerText = highscoreVal;

        mainCycle();
        }

        function mainCycle() {
        if (gameState !== 'playing') return;

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Synchronisation mit dem Server
        socket.emit('playerMove', {
        x: runner.x,
        y: runner.y,
        name: activeUser,
        room: currentRoomID
        });

        // Timer-Berechnung
        if (!document.getElementById('hud-timer').classList.contains('hidden')) {
        timerSeconds -= 1/60;
        document.getElementById('val-time').innerText = Math.ceil(timerSeconds);
        if (timerSeconds <= 0) handleGameOver();
        }

        // Physik: Sprung und Schwerkraft
        if (isJumpPressed && jumpCharge > 0) {
        runner.dy = -14.5;
        jumpCharge--;
        }

        runner.dy += runner.gravity;
        runner.y += runner.dy;

        // Bodenkollision
        if (runner.y > canvas.height - 100) {
        runner.y = canvas.height - 100;
        runner.dy = 0;
        runner.onGround = true;
        } else {
        runner.onGround = false;
        }

        // Andere Spieler (Ghosts) zeichnen
        for (let id in otherPlayers) {
        if (id !== socket.id) {
        let ghost = otherPlayers[id];
        ctx.fillStyle = "rgba(236, 72, 153, 0.4)";
        ctx.fillRect(ghost.x, ghost.y, runner.w, runner.h);
        ctx.fillStyle = "white";
        ctx.font = "12px sans-serif";
        ctx.fillText(ghost.name, ghost.x, ghost.y - 12);
        }
        }

        // Aktuellen Spieler zeichnen
        ctx.fillStyle = "#3b82f6";
        ctx.shadowBlur = 25;
        ctx.shadowColor = "#3b82f6";
        ctx.fillRect(runner.x, runner.y, runner.w, runner.h);
        ctx.shadowBlur = 0;

        // Bodenstreifen
        ctx.fillStyle = "#1e293b";
        ctx.fillRect(0, canvas.height - 50, canvas.width, 50);

        // Hindernis-Spawner
        if (Math.random() < 0.022) {
        if (activeObstacles.length === 0 || (canvas.width - activeObstacles[activeObstacles.length-1].x) > (worldSpeed * 42)) {
        let obsH = 50 + Math.random() * 105;
        activeObstacles.push({
        x: canvas.width,
        y: canvas.height - 50 - obsH,
        w: 42,
        h: obsH
        });
        }
        }

        // Hindernis-Logik & Zeichnen
        for (let i = activeObstacles.length - 1; i >= 0; i--) {
        let ob = activeObstacles[i];
        ob.x -= worldSpeed;

        ctx.fillStyle = "#ef4444";
        ctx.fillRect(ob.x, ob.y, ob.w, ob.h);

        // Kollisionspr√ºfung
        if (runner.x < ob.x + ob.w &&
        runner.x + runner.w > ob.x &&
        runner.y < ob.y + ob.h &&
        runner.y + runner.h > ob.y) {
        handleGameOver();
        }

        // Punktzahl & Entfernung
        if (ob.x < -60) {
        activeObstacles.splice(i, 1);
        gameScore++;
        worldSpeed += 0.009;
        document.getElementById('val-score').innerText = gameScore;
        }
        }

        requestAnimationFrame(mainCycle);
        }

        function handleGameOver() {
        if (gameState === 'over') return;
        gameState = 'over';
        sfxHit.play();

        if (gameScore > highscoreVal) {
        highscoreVal = gameScore;
        localStorage.setItem('ultraRunner_highscore', highscoreVal);
        }

        socket.emit('submitScore', { name: activeUser, score: highscoreVal });

        document.getElementById('final-score').innerText = gameScore;
        document.getElementById('final-best').innerText = highscoreVal;

        showScreen('screen-game-over');
        }

        function retryLastGame() {
        if (currentRoomID && isLobbyHost) {
        broadcastStartSignal();
        } else if (!currentRoomID) {
        startGameSession('normal');
        } else {
        alert("Warten auf den Host...");
        }
        }

        /* =========================================
        NETWORK SYNC LISTENERS
        ========================================= */
        socket.on('updatePlayers', (serverData) => {
        otherPlayers = serverData;
        if (currentRoomID) {
        let htmlOut = "";
        for (let sid in serverData) {
        const pData = serverData[sid];
        const isOwner = (pData.isHost || (sid === socket.id && isLobbyHost));
        const ownerBadge = isOwner ? '<span style="color:var(--gold-winner); font-size:10px; border:1px solid; padding:2px 5px; margin-left:10px; border-radius:4px;">OWNER</span>' : '';
        htmlOut += `<div style="margin: 12px 0; font-weight: 800; font-size: 18px;">‚Ä¢ ${pData.name} ${ownerBadge}</div>`;
        }
        document.getElementById('lobby-member-list').innerHTML = htmlOut;
        }
        });

        socket.on('updateRankings', (data) => {
        globalRankData = data;
        if (currentRankTab === 'global') buildRankingList();
        });

        /* =========================================
        CONTROLS & INPUT
        ========================================= */
        window.addEventListener('keydown', (e) => {
        if (e.code === 'Space' && runner.onGround && gameState === 'playing') {
        jumpCharge = 28;
        isJumpPressed = true;
        sfxJump.play();
        }
        });

        window.addEventListener('keyup', (e) => {
        if (e.code === 'Space') isJumpPressed = false;
        });

        // Touch/Mouse Support
        window.addEventListener('mousedown', () => {
        if (runner.onGround && gameState === 'playing') {
        jumpCharge = 28;
        isJumpPressed = true;
        sfxJump.play();
        }
        });
        window.addEventListener('mouseup', () => isJumpPressed = false);

        /* =========================================
        AMBIENT BACKGROUND
        ========================================= */
        let galaxy = [];
        function populateGalaxy() {
        bgCanvas.width = window.innerWidth;
        bgCanvas.height = window.innerHeight;
        galaxy = [];
        for (let i = 0; i < 200; i++) {
        galaxy.push({
        x: Math.random() * bgCanvas.width,
        y: Math.random() * bgCanvas.height,
        z: Math.random() * 2.8,
        v: Math.random() * 0.6
        });
        }
        }

        function loopGalaxy() {
        bctx.fillStyle = "#020617";
        bctx.fillRect(0, 0, bgCanvas.width, bgCanvas.height);

        bctx.fillStyle = "#ffffff";
        galaxy.forEach(star => {
        star.y += star.v;
        if (star.y > bgCanvas.height) star.y = 0;
        bctx.fillRect(star.x, star.y, star.z, star.z);
        });
        requestAnimationFrame(loopGalaxy);
        }

        window.addEventListener('resize', populateGalaxy);
        populateGalaxy();
        loopGalaxy();

    </script>
</body>
</html>
